image: registry.gitlab.com/ostrokach-docker/conda:latest

stages:
  - lint
  - build
  - test
  - post-test
  - deploy

# === Variables ===

variables:
  PACKAGE_VERSION: 0.0.29

.py36: &py36
  PYTHON_VERSION: "3.6"

.db_tools: &db_tools
  SUBPKG_NAME: db_tools

.df_tools: &df_tools
  SUBPKG_NAME: df_tools

.ml_tools: &ml_tools
  SUBPKG_NAME: ml_tools

.py_tools: &py_tools
  SUBPKG_NAME: py_tools

.sequence_tools: &sequence_tools
  SUBPKG_NAME: sequence_tools

.structure_tools: &structure_tools
  SUBPKG_NAME: structure_tools

.system_tools: &system_tools
  SUBPKG_NAME: system_tools

# === Configurations ===

.configure: &configure
  cache:
    key: ${CI_JOB_NAME}
    paths:
      - .ci/conda_packages/*.tar.bz2
      - .ci/conda_packages/urls.txt
  before_script:
    # Conda environment variables
    - export CONDA_PKGS_DIRS="$CI_PROJECT_DIR/.ci/conda_packages"
    # Make conda cache and bld folders
    - mkdir -p "$CI_PROJECT_DIR/conda-bld" "${CONDA_PKGS_DIRS}"
    # Conda configure
    - conda config --set channel_priority true
    - conda config --append pkgs_dirs "${CONDA_PKGS_DIRS}"
    - conda config --add channels bioconda
    - conda config --add channels kimlab
    - conda config --add channels conda-forge
    - conda config --add channels defaults
    # - case "${PACKAGE_VERSION}" in
    #   *dev*)
    #     conda config --append channels kimlab/label/dev;
    #     conda config --append channels kimlab;
    #   ;;
    #   *)
    #     conda config --append channels kimlab;
    #   ;;
    #   esac
    # Clear cache
    - rm -rf /opt/conda/pkgs/*
    # Update conda
    - conda update -n root -yq conda conda-build --no-channel-priority

# === Lint ===

lint:
  stage: lint
  <<: [*configure]
  variables:
    <<: [*py36]
  script:
    - cd $(dirname ${CI_CONFIG_PATH})
    - conda install -yq "python=${PYTHON_VERSION}" isort flake8 mypy
    - python -m isort -p ${CI_PROJECT_NAME} -c
    - python -m flake8
    # - black --config pyproject.toml --check .
    # MyPy does not support namespace packages until this issue gets resolved:
    # https://github.com/python/mypy/issues/1645
    # - python -m mypy -p ${CI_PROJECT_NAME}

# === Build ===

.build: &build
  stage: build
  script:
    - cd "${CI_PROJECT_DIR}/.ci/conda"
    - conda build .
      --no-test
      --python $PYTHON_VERSION
      --output-folder "$CI_PROJECT_DIR/conda-bld"
  artifacts:
    paths:
    - conda-bld

build-py36:
  <<: [*configure, *build]
  variables:
    <<: [*py36]

# === Test ===

.test: &test
  stage: test
  script:
    # Restore built packages
    - cp -r $CI_PROJECT_DIR/conda-bld/* /opt/conda/conda-bld/
    - conda index /opt/conda/conda-bld/
    # Run tests
    - cd ${CI_PROJECT_DIR}/.ci/conda
    - conda build .
      --test
      --python $PYTHON_VERSION
    # Code coverage
    - mkdir "${CI_PROJECT_DIR}/coverage"
    - mv "${CI_PROJECT_DIR}/.coverage" "${CI_PROJECT_DIR}/coverage/${SUBPKG_NAME}"
  coverage: /^TOTAL.* (\d+\%)/
  artifacts:
    paths:
      - environment-py${PYTHON_VERSION/./}.yml
      - "${CI_PROJECT_DIR}/coverage/${SUBPKG_NAME}"

db_tools-py36:
  <<: [*configure, *test]
  dependencies:
    - build-py36
  variables:
    <<: [*db_tools, *py36]

df_tools-py36:
  <<: [*configure, *test]
  dependencies:
    - build-py36
  variables:
    <<: [*df_tools, *py36]

ml_tools-py36:
  <<: [*configure, *test]
  dependencies:
    - build-py36
  variables:
    <<: [*ml_tools, *py36]

py_tools-py36:
  <<: [*configure, *test]
  dependencies:
    - build-py36
  variables:
    <<: [*py_tools, *py36]

sequence_tools-py36:
  <<: [*configure, *test]
  dependencies:
    - build-py36
  variables:
    <<: [*sequence_tools, *py36]

structure_tools-py36:
  <<: [*configure, *test]
  dependencies:
    - build-py36
  variables:
    <<: [*structure_tools, *py36]

system_tools-py36:
  <<: [*configure, *test]
  dependencies:
    - build-py36
  variables:
    <<: [*system_tools, *py36]

# === Docs ===

.docs: &docs
  stage: post-test
  <<: [*configure]
  script:
    # Restore built packages
    - cp -r $CI_PROJECT_DIR/conda-bld/* /opt/conda/conda-bld/
    - conda index /opt/conda/conda-bld/
    # Install required packages
    - conda install -yq --use-local "python=$PYTHON_VERSION" $CI_PROJECT_NAME
    - conda install -yq nbconvert ipython ipykernel pandoc
    - pip install -q sphinx sphinx_rtd_theme recommonmark nbsphinx coverage
    # Build docs
    - (cd docs && sphinx-apidoc ../$CI_PROJECT_NAME -o api/generated -TeMP)
    - sphinx-build docs public
    # Coverage
    - PROJECT_INSTALL_DIR=$(python -c "import kmtools; print(kmtools.__path__[0])") ;
      for i in coverage/* ; do
        echo "${i}" ;
        sed -i "s|/${CI_PROJECT_NAME}/|${PROJECT_INSTALL_DIR}/|g" "${i}" ;
      done
    - coverage combine coverage/*
    - coverage report
    - coverage html
    - mv htmlcov public/
  coverage: /^TOTAL.* (\d+\%)/
  dependencies:
    - build-py36
    - db_tools-py36
    - df_tools-py36
    - ml_tools-py36
    - py_tools-py36
    - sequence_tools-py36
    - structure_tools-py36
    - system_tools-py36

test-docs:
  <<: [*configure, *docs]
  variables:
    <<: [*py36]
  except:
    - master
    - tags

docs:
  <<: [*configure, *docs]
  variables:
    <<: [*py36]
  only:
    - master
    - tags
  except:
    - triggers
  artifacts:
    paths:
    - public

# === Deploy ===

.deploy: &deploy
  stage: deploy
  before_script:
    - conda install twine -yq --no-channel-priority
  script:
    # Rename wheels from `*-linux_x86_64.whl` to `*-manylinux1_x86_64.whl`
    # so that they can be uploaded to PyPI.
    - for i in $CI_PROJECT_DIR/conda-bld/linux-64/*.whl ; do
      echo $i ;
      if [[ $i = *"-linux_x86_64.whl" ]]; then
        mv "${i}" "${i%%-linux_x86_64.whl}-manylinux1_x86_64.whl" ;
      fi ;
      done
    # Development releases go to the Anaconda dev channel
    - if [[ ${PACKAGE_VERSION} = *"dev"* ]] ; then
        anaconda -t $ANACONDA_TOKEN upload $CI_PROJECT_DIR/conda-bld/linux-64/*.tar.bz2 -u kimlab --label dev --force --no-progress ;
       fi
    # Tagged releases go to the Anaconda and PyPI main channels
    - if [[ -n ${CI_COMMIT_TAG} ]] ; then
        anaconda -t $ANACONDA_TOKEN upload $CI_PROJECT_DIR/conda-bld/linux-64/*.tar.bz2 -u kimlab --no-progress ;
        twine upload $CI_PROJECT_DIR/conda-bld/linux-64/*.whl || true ;
      fi

deploy-py36:
  <<: *deploy
  dependencies:
    - build-py36

# === Pages ===

pages:
  stage: deploy
  before_script:
    - sudo yum install -y -q unzip
  script:
    # Create docs folder for the current version
    - mv public "v${PACKAGE_VERSION%.dev}"
    - mkdir public
    - mv "v${PACKAGE_VERSION%.dev}" public/
    # Create docs folder for each tag
    - 'for tag in $(git tag) ; do
      echo ${tag} ;
      curl -L --header "JOB-TOKEN: $CI_JOB_TOKEN"
      "https://gitlab.com/${CI_PROJECT_NAME}/${CI_PROJECT_NAMESPACE}/-/jobs/artifacts/${tag}/download?job=docs"
      -o artifact-${tag}.zip || continue ;
      unzip artifact-${tag}.zip -d public || continue ;
      rm -rf public/${tag} ;
      mv public/public public/${tag} ;
      done'
    # Create index file
    # TODO:
  dependencies:
    - docs
  artifacts:
    paths:
      - public
  only:
    - master
    - tags
  except:
    - triggers
